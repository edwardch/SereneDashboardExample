import{a as p,b as g,c as d,e as v,f as P}from"./chunk-K3EI6ARL.js";var l=g(P(),1),o=g(v(),1);var c=class extends l.DataGrid{constructor(e,t){super(e,t);this._rolePermissions={};this._implicitPermissions={};let s={},n=this.getSortedGroupAndPermissionKeys(s).map(r=>({Key:r,ParentKey:this.getParentKey(r),Title:s[r],GrantRevoke:null,IsGroup:r.charAt(r.length-1)===":"}));this.byParentKey=(0,o.toGrouping)(n,r=>r.ParentKey),this.setItems(n)}getIdProperty(){return"Key"}getItemGrantRevokeClass(e,t){if(!e.IsGroup)return e.GrantRevoke===t?" checked":"";let s=this.getDescendants(e,!0),i=s.filter(n=>n.GrantRevoke===t);return i.length?s.length===i.length?"checked":"checked partial":""}roleOrImplicit(e){if(this._rolePermissions[e])return!0;for(var t of Object.keys(this._rolePermissions)){var s=this._implicitPermissions[t];if(s&&s[e])return!0}for(var i of Object.keys(this._implicitPermissions)){var n=this.view.getItemById(i);if(n&&n.GrantRevoke==!0){var s=this._implicitPermissions[i];if(s&&s[e])return!0}}}getItemEffectiveClass(e){if(e.IsGroup){let s=this.getDescendants(e,!0),i=(0,o.count)(s,n=>n.GrantRevoke===!0||n.GrantRevoke==null&&this.roleOrImplicit(n.Key));return i===s.length||s.length===0?"allow":i===0?"deny":"partial"}return e.GrantRevoke===!0||e.GrantRevoke==null&&this.roleOrImplicit(e.Key)?" allow":" deny"}getColumns(){let e=[{name:(0,o.text)("Site.UserPermissionDialog.Permission"),field:"Title",format:l.SlickFormatting.treeToggle(()=>this.view,t=>t.Key,t=>{let s=t.item,i=this.getItemEffectiveClass(s);return'<span class="effective-permission '+i+'">'+(0,o.htmlEncode)(t.value)+"</span>"}),width:495,sortable:!1},{name:(0,o.text)("Site.UserPermissionDialog.Grant"),field:"Grant",format:t=>{let s=t.item,i=this.getItemGrantRevokeClass(s,!0);return"<span class='check-box grant no-float "+i+"'></span>"},width:65,sortable:!1,headerCssClass:"align-center",cssClass:"align-center"}];return this.options.showRevoke&&e.push({name:(0,o.text)("Site.UserPermissionDialog.Revoke"),field:"Revoke",format:t=>{let s=t.item,i=this.getItemGrantRevokeClass(s,!1);return'<span class="check-box revoke no-float '+i+'"></span>'},width:65,sortable:!1,headerCssClass:"align-center",cssClass:"align-center"}),e}setItems(e){l.SlickTreeHelper.setIndents(e,t=>t.Key,t=>t.ParentKey,!1),this.view.setItems(e,!0)}onViewSubmit(){return!1}onViewFilter(e){return!super.onViewFilter(e)||!l.SlickTreeHelper.filterById(e,this.view,t=>t.ParentKey)?!1:this.searchText?this.matchContains(e)||e.IsGroup&&(0,o.any)(this.getDescendants(e,!1),t=>this.matchContains(t)):!0}matchContains(e){return Select2.util.stripDiacritics(e.Title||"").toLowerCase().indexOf(this.searchText)>=0}getDescendants(e,t){let s=[],i=[e];for(;i.length>0;){let n=i.pop(),r=this.byParentKey[n.Key];if(!!r)for(let a of r)(!t||!a.IsGroup)&&s.push(a),i.push(a)}return s}onClick(e,t,s){if(super.onClick(e,t,s),e.isDefaultPrevented()||l.SlickTreeHelper.toggleClick(e,t,s,this.view,a=>a.Key),e.isDefaultPrevented())return;let i=$(e.target),n=i.hasClass("grant");if(n||i.hasClass("revoke")){e.preventDefault();let a=this.itemAt(t),m=i.hasClass("checked")||i.hasClass("partial");if(m?n=null:n=n!==m,a.IsGroup)for(var r of this.getDescendants(a,!0))r.GrantRevoke=n;else a.GrantRevoke=n;this.slickGrid.invalidate()}}getParentKey(e){e.charAt(e.length-1)===":"&&(e=e.substr(0,e.length-1));let t=e.lastIndexOf(":");return t>=0?e.substr(0,t+1):null}getButtons(){return[]}createToolbarExtensions(){super.createToolbarExtensions(),l.GridUtils.addQuickSearchInputCustom(this.toolbar.element,(e,t)=>{this.searchText=Select2.util.stripDiacritics((0,o.trimToNull)(t)||"").toLowerCase(),this.view.setItems(this.view.getItems(),!0)})}getSortedGroupAndPermissionKeys(e){var n;let t=(0,o.getRemoteData)("Administration.PermissionKeys"),s={};for(var i of t){let r=i;if(!r||r.charAt(r.length-1)==":"&&(r=r.substr(0,r.length-1),r.length===0)||e[r])continue;e[r]=(n=(0,o.tryGetText)("Permission."+r))!=null?n:r;let a=r.split(":"),m="",h="";for(let u=0;u<a.length-1;u++){m=m+a[u]+":";let f=(0,o.tryGetText)("Permission."+m);f==null&&(f=a[u]),e[m]=f,h=h+e[m]+":",s[m]=h}s[r]=h+e[r]}return t=Object.keys(e),t=t.sort((r,a)=>(0,o.turkishLocaleCompare)(s[r],s[a])),t}get value(){let e=[];for(let t of this.view.getItems())t.GrantRevoke!=null&&t.Key.charAt(t.Key.length-1)!=":"&&e.push({PermissionKey:t.Key,Granted:t.GrantRevoke});return e}set value(e){var t;for(let s of this.view.getItems())s.GrantRevoke=null;if(e!=null)for(let s of e){let i=this.view.getItemById(s.PermissionKey);i&&(i.GrantRevoke=(t=s.Granted)!=null?t:!0)}this.setItems(this.getItems())}get rolePermissions(){return Object.keys(this._rolePermissions)}set rolePermissions(e){if(this._rolePermissions={},e)for(let t of e)this._rolePermissions[t]=!0;this.setItems(this.getItems())}set implicitPermissions(e){if(this._implicitPermissions={},e)for(var t of Object.keys(e)){this._implicitPermissions[t]=this._implicitPermissions[t]||{};var s=e[t];if(s)for(var i of s)this._implicitPermissions[t][i]=!0}}};p(c,"PermissionCheckEditor"),c=d([l.Decorators.registerEditor("DashboardSample.Administration.PermissionCheckEditor",[l.IGetEditValue,l.ISetEditValue])],c);export{c as a};
//# sourceMappingURL=chunk-7S36WDRD.js.map
